define(["cCoreInherit","cUtility","cUIBase","cUIHashObserve","cWidgetFactory","cWidgetAbstractCalendar"],function(a,c,d,e,f){"user strict";var g="Calendar";if(!f.hasWidget(g)){var h=f.create("Abstract.Calendar"),j=new a.Class(h,{__propertys__:function(){this.chineseHoliday=this.CONSTANT.CALENDAR_CHINESE_HOLIDAY,this.holiday=this.CONSTANT.CALENDAR_COMMON_HOLIDAY,this.DAYTITLE=this.CONSTANT.CALENDAR_WEEKDAY_SHORTNAME,this.SDAYTITLE=this.CONSTANT.CALENDAR_WEEKDAY_SHORTNAME2,this.DAYTITLE2=this.CONSTANT.CALENDAR_WEEKDAY_NAME,this.addClass(d.config.prefix+this.CONSTANT.CALENDAR),this.startMonth=c.getServerDate(),this.startMonth.setDate(this.CONSTANT.CALENDAR_INIT_DATE),this.Months=this.CONSTANT.CALENDAR_MONTH,this.validStartDate=c.getServerDate(),this.validStartDate.setHours(this.CONSTANT.INIT_DATE_TIME.H,this.CONSTANT.INIT_DATE_TIME.M,this.CONSTANT.INIT_DATE_TIME.S,this.CONSTANT.INIT_DATE_TIME.MS),this.validEndDate,this.date,this.dateVal={},this.titledom,this.leftback,this.cls=[this.CONSTANT.CALENDAR],this.title,this.noabsolute=!1,this.curDate,this.dateDoms={},this.html,this.clickEnabled=!0,this.msg="",this.callback=function(){},this.hashObserve=new e({hash:this.id,callback:function(){this._hide()},scope:this}),this.animatSwitch=!1,this.timeNum=250},initialize:function($super,a){this.setOption(function(a,b){switch(a){case"Months":case"timeNum":case"date":case"curDate":case"root":case"callback":case"title":case"noabsolute":case"msg":case"clickEnabled":case"animatSwitch":this[a]=b;break;case"cls":this.cls.push(b);break;case"validStartDate":case"validEndDate":this[a]=b,this[a].setHours(0,0,0,0);break;case"startMonth":this[a]=b,this[a].setDate(1)}}),$super(a),this.buildEvent()},selectedDate:function(){var a;for(var b in this.date)a=this.root.find("."+this.buildSelectCls(b))[0],this.dateDoms[b]=a,this.dateVal[b]=this.date[b].value;!this.curDate&&(this.curDate=b)},buildEvent:function(){this.addEvent("onCreate",this.onCreate),this.addEvent("onShow",this.onShow),this.addEvent("onHide",this.onHide)},buildElement:function(){this.titledom=this.root.find("header"),this.leftback=this.root.find("#js_return")},onCreate:function(){this.selectedDate(),this.buildElement(),this.buildElementsEvent(),this.noabsolute||this.root.css({position:"absolute"}),this.windowResizeHander=$.proxy(this.position,this)},onShow:function(){if(this.root.css({top:0,left:0,width:"100%"}),$(window).bind("resize",this.windowResizeHander),this.setzIndexTop(),this.hashObserve.start(),this.animatSwitch){var a=this;window.scrollTo(0,0),this.root.animate({"-webkit-transform":"translate(100%, 0px) translateZ(0px)",top:"0px"},0,function(){a.root.animate({"-webkit-transform":"translate(0px, 0px) translateZ(0px)"},a.timeNum,function(){a.windowResizeHander()})})}},position:function(){this.root.css({left:"0px",top:"0px"});var a=d.getPageSize();this.root.css({width:$(window).width(),height:a.height})},onHide:function(){$(window).unbind("resize",this.windowResizeHander),this.hashObserve.end()},createHtml:function(){return this.createCalendar()},buildElementsEvent:function(){var a=this;this.clickEnabled&&this.root.delegate(".cui_cld_daybox li","click",function(){b=$(this),b.hasClass("valid")||(b=b.closest(".valid"));var d=b.attr("data-date");d&&(d=c.Date.parse(d).valueOf(),a.isAccordBound(d)&&a._setDate(d,b))}),this.root.delegate("#js_return","click",$.proxy(function(){this._hide()},this))},_hide:function(){if(this.animatSwitch){var a=this;this.root.animate({"-webkit-transform":"translate(0px, 0px) translateZ(0px)",top:"0px"},0,function(){a.root.animate({"-webkit-transform":"translate(100%, 0px) translateZ(0px)"},a.timeNum,function(){a.hide()})})}else this.hide()},isAccordBound:function(a){var b=this.date[this.curDate];if(!b.bound)return!0;if(!b.bound.rules||!b.bound.error)return!0;var c,d=b.bound.rules;for(var e in d)if(c="string"==typeof d[e]?this.dateVal[d[e]]:this._isDate(d[e])&&d[e],a.setHours(0,0,0,0),c)switch(c.setHours(0,0,0,0),e){case"<":if(!(c>a))return b.bound.error.call(this,a,this.curDate,this.dateVal),!1;break;case">":if(!(a>c))return b.bound.error.call(this,a,this.curDate,this.dateVal),!1;break;case"<=":if(!(c>=a))return b.bound.error.call(this,a,this.curDate,this.dateVal),!1;break;case">=":if(!(a>=c))return b.bound.error.call(this,a,this.curDate,this.dateVal),!1}return!0},_setDate:function(a,b){var d=this.root.find("."+this.buildSelectCls(this.curDate));d.each($.proxy(function(a,b){var e=$(b);e.html(this.formatTitle(c.Date.parse(d.attr("data-date")).valueOf())),e.removeClass(this.buildSelectCls(this.curDate)),e.removeClass(this.buildSelectCls())},this)),this.dateDoms[this.curDate]=b;var e,f=$(b),g=this.date[this.curDate].title;e="function"==typeof g?this.formatTitle2(g):this.formatTitle,f.html(e.call(this,a)),f.removeClass("cui_cld_dayfuture"),f.removeClass("cui_cld_day_hint"),f.addClass("cui_cld_day_havetxt"),f.addClass(this.buildSelectCls(this.curDate)),f.addClass(this.buildSelectCls()),this.dateVal[this.curDate]=a,this.callback&&this.callback.call(this,a,this.curDate,this.dateVal,this.getDateInfo(a),this.calendarend)},setCurDate:function(a){this.curDate=a,this.create();var b=this.getCurTitle();this.titledom.html(b)},getEndDate:function(){return this.calendarend},buildSelectCls:function(a){return a?"selected-"+a:"cui_cld_daycrt"},getCurTitle:function(){var a=this.date[this.curDate],b="";return a&&(b=a.headtitle||this.title),b||this.title},createCalendar:function(){var a,b=[],d=this.getCurTitle(),e=c.isInApp(),f=e?' style=" margin-top: 0"':"";this.title&&!e&&b.push(["<header>","<h1>"+d+'</h1><i class="returnico i_bef" id="js_return"></i>',"</header>"].join("")),b.push(['<article class="cont_wrap"',f,'><div class="cui_cldwrap">'].join("")),b.push(this.createWeek(e));for(var g=0;g<this.Months;g++)a=new Date(this.startMonth),a.setMonth(a.getMonth()+g),b.push(this.createMonth(a));return b.push(["</div></atricle>"].join("")),b.join("")},createWeek:function(a){var b=a?" cui_cldweek_top0":"",c=['<ul class="cui_cldweek'+b+'">'];this.msg&&c.push('<p  class="cui_cldmsg">'+this.msg+"</p>");for(i in this.SDAYTITLE)c.push("<li>"+this.SDAYTITLE[i]+"</li>");return c.push("</ul>"),c.join("")},createMonth:function(a){var b,d=this.calcStructData(a),e=[];e.push('<section class="cui_cldunit">'),e.push('<h1 class="cui_cldmonth">'+c.Date.format(a,"Y年n月")+"</h1>"),e.push('<ul class="cui_cld_daybox">');for(var f,g,h=d.days.length,b=0;h>b;b++){g=d.days[b].length;for(var i=0;g>i;i++){f={};var j=d.days[b][i];if(j){var k=this.validStartDate||d.start,l=this.validEndDate||d.end;j>=k&&l>=j?f.valid=!0:(f.cui_cld_daypass=!0,f.invalid=!0)}else f.cui_cld_dayfuture=!0,f.invalid=!0;var m,n=this.getDateInfo(j);if(n?(m=n.daytitle||n.holiday||n.chineseday,m?(f.cui_cld_day_havetxt=!0,(n.holiday||n.chineseday)&&(f.cui_cld_day_hint=!0),m="<em>"+n.date+"</em><i>"+m+"</i>"):m="<em>"+n.date+"</em>"):m="",this.date)for(var o in this.date)j&&c.Date.format(this.dateVal[o]||this.date[o].value,"Y-m-d")==c.Date.format(j,"Y-m-d")&&(delete f.cui_cld_dayfuture,delete f.cui_cld_day_hint,f.cui_cld_day_havetxt=!0,f[this.buildSelectCls()]=!0,f[this.buildSelectCls(o)]=!0,m=this.date[o].title(j,function(){return n.daytitle||n.holiday||n.chineseday||n.date}),m="<em>"+m+"</em>");e.push('<li data-date="'+c.Date.format(j,"Y-m-d")+'" '+(f?' class="'+this._objectKey(f).join(" ")+'"':"")+">"+m+"</li>")}}return e.push("</ul></section>"),e.join("")},formatTitle:function(a){if(a){var b=this.getDateInfo(a);return b.holiday||b.chineseday||b.daytitle||b.date}return""},getDateInfo:function(a){if(a){var b=c.getServerDate(),d=new Date(a);d.setHours(1,1,1,0),b.setHours(1,1,1,0);var e=(d-b)/864e5,f={};f.daytitle=c.Date.format(b,"Ymd")==c.Date.format(a,"Ymd")?"今天":1==e?"明天":2==e?"后天":"";var g=this.solarDay2(a);f.chineseday=this.chineseHoliday[g]?this.chineseHoliday[g]:"";var h=c.Date.format(a,"md");return f.holiday=this.holiday[h]?this.holiday[h]:"",f.week=this.DAYTITLE[a.getDay()],f.week2=this.DAYTITLE2[a.getDay()],f.date=c.Date.format(a,"j"),f}},formatTitle2:function(a){return $.proxy(function(b){return a(b,$.proxy(function(a){return this.formatTitle(a)},this))},this)},calcStructData:function(a){var b=new Date(a),c=new Date(a);b.setDate(1),b.setHours(0,0,0,0);var d=b.getDay();c.setMonth(c.getMonth()+1,1),c.setHours(-24,0,0,0);for(var e,f=c.getDay(),g=(c.getDate()+(d+(6-f)))/7,h=[],i=0,j=0;g>i;i++){h[i]=[];for(var k=0;7>k;k++)if(0==i&&d>k)h[i].push("");else{if(e=new Date(b),e.setDate(e.getDate()+j),e>c)break;h[i].push(e),j++}}return this.calendarend=c,{start:b,end:c,days:h,loops:g}},setDate:function(a){this.create();for(var b in a)if(this.date[b]&&this._isDate(a[b])){a[b].setHours(0,0,0,0),this.date[b].value=a[b],this.dateVal[b]=a[b];var d=this.root.find("."+this.buildSelectCls(b));if(d.length){var e=c.Date.parse(d.data("date")).valueOf();d.removeClass(this.buildSelectCls(b)),d.removeClass(this.buildSelectCls()),d.html(this.formatTitle(e))}var f=this.root.find('[data-date="'+c.Date.format(a[b],"Y-m-d")+'"]');f.each($.proxy(function(c,d){d=$(d),d.hasClass("valid")&&(d.addClass(this.buildSelectCls(b)),d.addClass(this.buildSelectCls()),d.html(this.formatTitle2(this.date[b].title)(a[b])))},this)),this.dateDoms[b]=f}},addDate:function(a,b){this.create();var d,e,f;for(var g in a)if(!this.date[g]||b){this.date[g]=a[g],d=this.date[g]&&this.date[g].value,e=this.date[g]&&this.date[g].title,e="function"==typeof e?this.formatTitle2(e):$.proxy(this.formatTitle,this);var h=this.root.find("."+this.buildSelectCls(g));h.length&&(h.removeClass(this.buildSelectCls(g)),h.removeClass(this.buildSelectCls())),d&&(f=this.root.find('[data-date="'+c.Date.format(d,"Y-m-d")+'"]'),f.each($.proxy(function(a,b){b=$(b),b.hasClass("valid")&&(b.html(e(d)),b.addClass(this.buildSelectCls(g)),b.addClass(this.buildSelectCls()),this.dateVal[g]=d)},this)))}},removeDate:function(a){this.create();for(var b,d=0,e=a.length;e>d;d++)if(b=a[d],this.date[b]){var f=this.root.find("."+this.buildSelectCls(b));f.each($.proxy(function(a,d){var e=$(d);e.removeClass(this.buildSelectCls(b)),e.removeClass(this.buildSelectCls()),e.html(this.formatTitle(c.Date.parse(e.data("date")).valueOf()))},this)),delete this.date[b],delete this.dateVal[b]}},getDate:function(){var a={};for(var b in this.date)a[b]=this.date[b].value;return _.isEmpty(this.dateVal)?_.isEmpty(a)?{}:a:this.dateVal},update:function(a){this.setOption(function(a,b){switch(a){case"Months":case"date":case"curDate":case"root":case"callback":case"title":case"noabsolute":this[a]=b;break;case"cls":this.cls.push(b);break;case"validStartDate":case"validEndDate":this[a]=b,this[a].setHours(0,0,0,0);break;case"startMonth":this[a]=b,this[a].setDate(1)}}),this.readOption(a),this.create(),this.root.html(this.createCalendar()),this.trigger("onChange")}});f.register({name:g,fn:j})}});