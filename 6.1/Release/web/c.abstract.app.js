define(["libs","cBase","cUIAnimation"],function(a,b,c){var d=new b.Class({__propertys__:function(){this.webroot="/#hotelsearch",this.viewRootPath="app/views/",this.defaultView="index",this.request,this.viewpath,this.mainframe,this.viewport,this.statedom,this.views=new b.Hash,this.curView,this.lastView,this.inteface={loadView:_.bind(this.loadView,this),forward:_.bind(this.forward,this),back:_.bind(this.back,this)},this.isCreate=!1,this.history=[],this.stopListening=!1,this.timeoutres,this.lastHash="",this.lashFullHash="",this.isChangeHash=!1,this.animations=c,this.isAnimat=!0,this.animatSwitch=!1,b.isInApp()&&(this.animatSwitch=!0),this.animForwardName="slideleft",this.animBackwardName="slideright",this.animNoName="noAnimate",this.animatName=this.animNoName,this.path=[],this.query={},this.viewMapping={}},initialize:function(a){this.setOption(a),this.buildEvent()},setOption:function(a){a=a||{};for(var b in a)this[b]=a[b]},buildEvent:function(){requirejs.onError=function(a){if(a&&a.requireModules)for(var b=0;b<a.requireModules.length;b++){0;break}},$(window).bind("hashchange",_.bind(this.onHashChange,this)),this.onHashChange(),this.pushHistory()},onHashChange:function(){if(!this.stopListening){var a=decodeURIComponent(location.href).replace(/^[^#]+(#(.+))?/g,"$2").toLowerCase();this._onHashChange(a)}},_onHashChange:function(a,b){a=a.replace(/^#+/i,"");var c=this.parseHash(a);this.localObserver(c,b)},parseHash:function(a){function b(a){for(var b,c,d,a=a.split("://"),e=/([^&=?]+)=([^&]+)/g,f={};b=e.exec(a[0]);)name=b[1],c=b[2],f[name]=c;if(a[1]){var g=0;d=_.size(f),_.each(f,function(b,c){++g==d&&(f[c]+="://"+a[1])})}return f}var c=a,a=a.replace(/([^\|]*)(?:\|.*)?$/gim,"$1"),d=/^([^?&|]*)(.*)?$/i.exec(a),e=d[1]?d[1].split("!"):[],f=(e.shift()||"").replace(/(^\/+|\/+$)/i,""),g=e.length?e.join("!").replace(/(^\/+|\/+$)/i,"").split("/"):this.path;return this.isChangeHash=!(this.lastHash||c!==this.lashFullHash)||!(!this.lastHash||this.lastHash===a),-1!=location.hash.indexOf("cui-")&&(this.isChangeHash=!1),this.lastHash=a,this.lashFullHash=c,{viewpath:f,path:g,query:b(c),root:location.pathname+location.search,fullhash:c}},localObserver:function(a,b){this.animatName=b?this.animForwardName:this.animBackwardName,this.request=a,this.viewpath=this.request.viewpath||this.defaultView,this.request.viewpath=this.viewpath,this.switchView(this.viewpath)},switchView:function(a){var b=a,c=this.views.getItem(b),d=this.curView;if(d&&d!=c&&(this.lastView=d),c){if(c==this.curView&&0==this.isChangeHash)return;c.request=this.request,this.curView=c;var e=(d||c).viewname;this.curView.__load(e)}else this.loadView(a,function(a){c=new a(this.request,this.inteface,b),this.views.push(b,c),c.turning=_.bind(function(){this.createViewPort(),c.viewport=this.viewport,this.startAnimation(function(a,b){this.views.each(function(c){return a===c||b===c?!1:void c.$el.hide()}),a.$el.show()})},this),this.curView=c;var e=(d||c).viewname;this.curView.__load(e)})},startAnimation:function(a){var b=this.curView,c=this.lastView;c&&(c.scrollPos={x:window.scrollX,y:window.scrollY}),this.animatSwitch||(this.isAnimat=!1),this.isAnimat||(this.animatName=this.animNoName),this.timeoutres=this.animations[this.animatName]&&this.animations[this.animatName].call(this,b,c,a,this),this.isAnimat=!0},loadView:function(a,b){var c=this;requirejs([this.buildUrl(a)],function(a){b&&b.call(c,a)})},buildUrl:function(a){var b=this.viewMapping[a];return b?b:this.viewRootPath+a},createViewPort:function(){if(!this.isCreate){var a=['<div class="main-frame">','<div class="main-viewport"></div>','<div class="main-state"></div>',"</div>"].join("");this.mainframe=$(a),this.viewport=this.mainframe.find(".main-viewport"),this.statedom=this.mainframe.find(".main-state");var b=$("#main");b.empty(),b.append(this.mainframe),this.isCreate=!0}},lastUrl:function(){return this.history.length<2?document.referrer:this.history[this.history.length-2]},startObserver:function(){this.stopListening=!1},endObserver:function(){this.stopListening=!0},forward:function(a,b,c){a=a.toLowerCase(),c&&(this.isAnimat=!1),this.endObserver(),b?window.location.replace(("#"+a).replace(/^#+/,"#")):window.location.href=("#"+a).replace(/^#+/,"#"),this.pushHistory(),this._onHashChange(a,!0),setTimeout(_.bind(this.startObserver,this),1)},back:function(a,b){b&&(this.isAnimat=!1);var c=this.lastUrl();c&&this.history.pop(),!a||c&&0===c.indexOf(a)?(a=this.request.query.refer,a?window.location.href=a:history.back()):window.location.hash=a},pushHistory:function(){var a=window.location.href;this.history.push(a)}});return d});