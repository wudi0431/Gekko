define(["libs","cBase","AbstractAPP","cWidgetFactory","cWidgetGuider"],function(a,b,c,d){var e=new b.Class(c,{__propertys__:function(){this.appMode="phone",this.padHistory=[],this.animForwardName="fadein",this.animBackwardName="fadeout",this.animatSwitch=!1,this.padHistory={history:[],main:[],sub:[]},this.curMainView=null,this.curSubView=null,this.lastMainView=null,this.lastSubView=null},getAppMode:function(){return this.appMode},initialize:function($super,a){this.initWebAppMode(),this.setInterface("notify",this.notify),this.setInterface("getAppMode",this.getAppMode),$super(a);var b=d.create("Guider");b.create(),$.bindFastClick&&$.bindFastClick();var c="onorientationchange"in window,e=c?"orientationchange":"resize";window.addEventListener(e,$.proxy(function(){this.appMode=0==window.orientation||180==window.orientation?"phone":"pad";var a=$(window).width();this.appMode=a>800?"pad":"phone";var b=this.request.fullhash,c=this._parsePath(b);"pad"==this.appMode?this.switchPadMode(c):this.switchPhoneMode(c)},this),!1),this.openIpadAdapte=!1},switchPadMode:function(a){this._loadView(a.mainPath,"main",function(){this._loadView(a.subPath,"sub")})},switchPhoneMode:function(a){this.switchView(a.history)},initWebAppMode:function(){var a=$.os.ipad||$.os.tablet;a=!0;var b=$(window).width();this.appMode=a&&b>850?"pad":"phone"},adaptePad:function(){},_parsePath:function(a){if(!a)return!1;var b=a.split("!");if(2!=b.length)return!1;var c={},d=b[0],e=b[1];return-1!=d.indexOf("@")&&(c.history=d=d.substr(1)),-1!=e.indexOf("@")&&(c.history=e=e.substr(1)),c.mainPath=d,c.subPath=e,c},switchView:function(a){if(a){if(a=-1!=this.viewpath.indexOf("@")?this.viewpath:a,a=-1!=this.request.fullhash.indexOf("@")?this.request.fullhash:a,-1==a.indexOf("@"))return void this._loadView(a,"main");var b=this._parsePath(a),c=b.mainPath,d=b.subPath;this.padHistory.history.push(b.history),this.padHistory.main.push(c),this.padHistory.sub.push(d),"pad"==this.appMode?this._loadView(c,"main",function(){this._loadView(d,"sub")}):this._loadView(b.history,"main")}},_loadView:function(a,b,c){if(a){this.createViewPort(),b||(b="main"),this.viewFlag=b,this._callback=c;var d=this.padHistory.main[this.padHistory.main.length-2],e=this.padHistory.sub[this.padHistory.sub.length-2];this.lastMainView=null,this.lastSubView=null,"main"==b&&(this.lastMainView=d?this.views.getItem(d):null,this.lastSubView=e?this.views.getItem(e):null);var f=a,g=this.views.getItem(f);g?(g.request=this.request,g.viewFlag=this.viewFlag,this.curView=g,g.__load()):this.loadView(a,function(a){g=new a(this.request,this.inteface,f),this.views.push(f,g),g.turning=_.bind(function(){g.viewport=this.viewport,g.viewFlag=this.viewFlag,this.curView=g,this.lastMainView&&this.lastMainView!=g&&(this.lastMainView.__onHide(),this.lastMainView.__hide()),this.lastSubView&&this.lastView!=g&&(this.lastSubView.__onHide(),this.lastSubView.__hide()),g.__show(),g.__onShow(),g.onLoadView&&g.onLoadView(),this._callback&&this._callback.call(this)},this),g.viewFlag=this.viewFlag,g.__load()})}},notify:function(a,b){var c=this.views.getItem(a);this.viewFlag=c.viewFlag,c&&c.onUpdate&&(c.onUpdate?c.onUpdate(b):c.onLoad())},forward:function(a,b,c){var d=this._parsePath(a),e=this.padHistory.history.length-1;if("pad"!=this.appMode||d.history!=this.padHistory.history[e]||this.padHistory.main[e]!=d.mainPath||this.padHistory.sub[e]!=d.subPath)a=a.toLowerCase(),c&&(this.isAnimat=!1),this.endObserver(),b?window.location.replace(("#"+a).replace(/^#+/,"#")):window.location.href=("#"+a).replace(/^#+/,"#"),this._onHashChange(a,!0),setTimeout(_.bind(this.startObserver,this),1);else{var f=d.history;this.notify(f)}}});return e});