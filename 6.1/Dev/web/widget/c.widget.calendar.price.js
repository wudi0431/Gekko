define(["cCoreInherit","cUtility","cUIBase","cWidgetFactory","cWidgetAbstractCalendar","cWidgetGuider"],function(a,c,d,e){"user strict";var f="Calendar.Price",g=0;if(!e.hasWidget(f)){var h=e.create("Guider"),j=e.create("Abstract.Calendar"),k=new a.Class(j,{__propertys__:function(){this.chineseHoliday=this.CONSTANT.CALENDAR_CHINESE_HOLIDAY,this.holiday=this.CONSTANT.CALENDAR_COMMON_HOLIDAY,this.DAYTITLE=this.CONSTANT.CALENDAR_WEEKDAY_SHORTNAME,this.SDAYTITLE=this.CONSTANT.CALENDAR_WEEKDAY_SHORTNAME2,this.addClass(d.config.prefix+this.CONSTANT.CALENDAR),this.showChineseHoliday=!0,this.showHoliday=!0,this.startMonth=c.getServerDate(),this.startMonth.setDate(this.CONSTANT.CALENDAR_INIT_DATE),this.Months=this.CONSTANT.CALENDAR_MONTH,this.validStartDate=c.getServerDate(),this.validStartDate.setHours(this.CONSTANT.INIT_DATE_TIME.H,this.CONSTANT.INIT_DATE_TIME.M,this.CONSTANT.INIT_DATE_TIME.S,this.CONSTANT.INIT_DATE_TIME.MS),this.validEndDate,this.date,this.onlyread=!1,this.dateVal={},this.cls=[this.CONSTANT.CALENDAR],this.curDate,this.dateDoms={},this.html,this.windowResizeHander,this.animatSwitch=!1,this.lowerPriceClass="",this.holidayClass="",this.todayClass="",this.lowestpriceMap={},this._formatPrice=function(a,b){return b(a)},this.callback=function(){},this.title=!1,this.returnCallback=function(){}},initialize:function($super,a){this.setOption(function(a,b){switch(a){case"Months":case"curDate":case"root":case"callback":case"onlyread":case"title":case"returnCallback":case"showChineseHoliday":case"animatSwitch":case"lowerPriceClass":case"holidayClass":case"todayClass":this[a]=b;break;case"date":if(b)for(var c in b)this.dateVal[c]=b[c].value;this[a]=b;break;case"formatPrice":this._formatPrice=b;break;case"showHoliday":this[a]=b;break;case"validDates":this[a]=b;break;case"cls":this.cls.push(b);break;case"validStartDate":case"validEndDate":this[a]=b,this[a].setHours(1,1,1,0);break;case"startMonth":this[a]=b,this[a].setDate(1)}}),$super(a),this.buildEvent(),this.lowerPriceClass&&this.validDates&&this.sortMonthPrice()},sortMonthPrice:function(){this.lowestpriceMap={};var a=this;$.each(this.validDates,function(b){var c=a.validDates[b].date;return"undefined"==typeof a.lowestpriceMap[c.getFullYear().toString()+c.getMonth().toString()]?void(a.lowestpriceMap[c.getFullYear().toString()+c.getMonth().toString()]=a.validDates[b].price):a.lowestpriceMap[c.getFullYear().toString()+c.getMonth().toString()]>a.validDates[b].price?void(a.lowestpriceMap[c.getFullYear().toString()+c.getMonth().toString()]=a.validDates[b].price):void 0})},selectedDate:function(){var a;for(var b in this.date)a=this.root.find("."+this.buildSelectCls(b))[0],this.dateDoms[b]=a,this.dateVal[b]=this.date[b].value;!this.curDate&&(this.curDate=b)},buildEvent:function(){this.addEvent("onCreate",this.onCreate),this.addEvent("onShow",this.onShow),this.addEvent("onHide",this.onHide)},onCreate:function(){this.selectedDate(),this.buildElementsEvent(),this.root.css({position:"absolute"}),this.windowResizeHander=$.proxy(this.position,this)},onShow:function(){$(window).bind("resize",this.windowResizeHander),this.root.css("z-index","1000"),this.windowResizeHander(),setTimeout(this.windowResizeHander,100);var a=this;if(h.apply({hybridCallback:function(){a.root.find(".cui_cldweek").css("top","0")},callback:function(){}}),this.animatSwitch){var a=this;window.scrollTo(0,0),this.root.animate({"-webkit-transform":"translate(100%, 0px) translateZ(0px)",top:"0px"},0,function(){a.root.animate({"-webkit-transform":"translate(0px, 0px) translateZ(0px)"},a.timeNum,function(){a.windowResizeHander()})})}},position:function(){this.root.css({left:"0px",top:"0px"});var a=d.getPageSize();this.root.css({width:$(window).width(),height:a.height})},onHide:function(){$(window).unbind("resize",this.windowResizeHander)},createHtml:function(){return this.createCalendar()},buildElementsEvent:function(){var a=this;this.root.delegate("li.valid","click",function(){b=$(this),b.hasClass("valid")||(b=b.closest(".valid"));var d=c.Date.parse(b.attr("data-date")).valueOf();a.isAccordBound(d)&&a._setDate(d,b)}),this.root.delegate("#js_return","click",$.proxy(function(){this.returnCallback&&this.returnCallback(),this.hide()},this))},_hide:function(){if(this.animatSwitch){var a=this;this.root.animate({"-webkit-transform":"translate(0px, 0px) translateZ(0px)",top:"0px"},0,function(){a.root.animate({"-webkit-transform":"translate(100%, 0px) translateZ(0px)"},a.timeNum,function(){a.hide()})})}else this.hide()},isAccordBound:function(a){var b=this.date[this.curDate];if(!b.bound)return!0;if(!b.bound.rules||!b.bound.error)return!0;var c,d=b.bound.rules;for(var e in d)switch(c="string"==typeof d[e]?this.dateVal[d[e]]:this._isDate(d[e])&&d[e],e){case"<":if(!(c>a))return b.bound.error.call(this,a,this.curDate,this.dateVal),!1;break;case">":if(!(a>c))return b.bound.error.call(this,a,this.curDate,this.dateVal),!1;break;case"<=":if(!(c>=a))return b.bound.error.call(this,a,this.curDate,this.dateVal),!1;break;case">=":if(!(a>=c))return b.bound.error.call(this,a,this.curDate,this.dateVal),!1}return!0},_setDate:function(a,b){if(!this.onlyread){if(this.dateDoms[this.curDate]){var c=$(this.dateDoms[this.curDate]);c.removeClass(this.buildSelectCls(this.curDate)),c.removeClass(this.buildSelectCls())}this.dateDoms[this.curDate]=b;var d,e=$(b),f=this,g=this.date[this.curDate].title;d="function"==typeof g?function(a){return g(a,function(a){return f.formatTitle(a)})}:this.formatTitle;{var h=parseFloat(parseInt(100*(b.attr("data-price")||0))/100);$.proxy(this.formatPrice,this)}e.addClass(this.buildSelectCls(this.curDate)),e.addClass(this.buildSelectCls()),this.dateVal[this.curDate]=a;var i=($.grep(this.validDates,function(b){var c=b.date.valueOf()==a.valueOf();return c}),e.html().replace(/^\d+/gm,""));isNaN(i)===!1&&(i=this.DAYTITLE[a.getDay()]),this.callback&&this.callback.call(this,a,h,i,this.dateVal)}},setCurDate:function(a){this.curDate=a},buildSelectCls:function(a){return a?"selected-"+a:"cui_cld_daycrt"},createCalendar:function(){var a,b=[];this.title&&b.push(["<header>","<h1>"+this.title+'</h1><i class="returnico i_bef" id="js_return"></i>',"</header>"].join("")),b.push(['<article class="cont_wrap" style="margin: 0 0 0">','<div class="cui_cldwrap">'].join("")),b.push(this.createWeek());for(var c=0;c<this.Months;c++)a=new Date(this.startMonth),a.setMonth(a.getMonth()+c),b.push(this.createMonth(a));return b.push(["</div></atricle>"].join("")),b.join("")},createWeek:function(){var a=['<ul class="cui_cldweek">'];for(i in this.SDAYTITLE)a.push("<li>"+this.SDAYTITLE[i]+"</li>");return a.push("</ul>"),a.join("")},createMonth:function(a){var b,d=this.calcStructData(a),e=[];e.push('<section class="cui_cldunit">'),e.push('<h1 class="cui_cldmonth">'+c.Date.format(a,"Y年n月")+"</h1>"),e.push('<ul class="cui_cld_daybox">');var f,h,i=d.days.length,j=this;0;for(var b=0;i>b;b++){h=d.days[b].length;for(var k=0;h>k;k++){g++,f={};var l=d.days[b][k];if(l){var m=this.validStartDate||d.start,n=this.validEndDate||d.end;l>=m&&n>=l?(f.cui_cld_dayfuture=!0,f.valid=!0):(f.cui_cld_daypass=!0,f.invalid=!0)}else f.cui_cld_dayfuture=!0,f.invalid=!0;var o="",p="";if(this.validDates&&l){var q=$.grep(this.validDates,function(a){return a.date.getFullYear()===l.getFullYear()&&a.date.getMonth()===l.getMonth()&&a.date.getDate()===l.getDate()?!0:!1});0===q.length?(delete f.valid,f.invalid=!0):(f.cui_cld_day_havetxt=!0,o=q[0].price,p=l.getFullYear().toString()+l.getMonth().toString())}var r=this.formatTitle;if(this.date)for(var s in this.date)this.dateVal[s]&&f.valid&&c.Date.format(this.dateVal[s]||this.date[s].value,"Y-m-d")==c.Date.format(d.days[b][k],"Y-m-d")&&(delete f.cui_cld_dayfuture,delete f.cui_cld_day_hint,f[this.buildSelectCls()]=!0,f[this.buildSelectCls(s)]=!0,r=function(a){return function(b){return a(b,function(a){return j.formatTitle(a)})}}(this.date[s].title));var t=$.proxy(this.formatPrice,this),u=this._formatPrice(o,t,!!f.valid);o&&this.lowerPriceClass&&p&&this.lowestpriceMap[p]===o&&(u=u.split("<i>").join('<i class="'+this.lowerPriceClass+'">'));var v=r.call(this,l);if(l&&v!=l.getDate()){var w=c.getServerDate(),x=new Date(l);x.setHours(1,1,1,0),w.setHours(1,1,1,0);var y=(x-w)/864e5;v=2>=y?'<em class="'+this.todayClass+'">'+v+"</em>":this.holidayClass?'<em class="'+this.holidayClass+'">'+v+"</em>":"<em>"+v+"</em>"}else v="<em>"+v+"</em>";e.push('<li data-price="'+o+'" data-date="'+c.Date.format(l,"Y-m-d")+'" '+(f?' class="'+this._objectKey(f).join(" ")+'"':"")+">"+v+u+"</li>")}}return e.push("</ul></section>"),e.join("")},formatPrice:function(a){return a>0?"<i>&yen;"+a+"</i>":""},formatTitle:function(a){if(!a)return"";var b=c.getServerDate();if(c.Date.format(b,"Ymd")==c.Date.format(a,"Ymd"))return"今天";var d=new Date(a);d.setHours(1,1,1,0),b.setHours(1,1,1,0);var e=(d-b)/864e5;if(1==e)return"明天";if(2==e)return"后天";if(this.showChineseHoliday===!0){var f=this.solarDay2(a);if(this.chineseHoliday[f])return this.chineseHoliday[f]}if(1==this.showHoliday){var g=c.Date.format(a,"md");if(this.holiday[g])return this.holiday[g]}return c.Date.format(a,"j")},calcStructData:function(a){var b=new Date(a),c=new Date(a);b.setDate(1),b.setHours(0,0,0,0);var d=b.getDay();c.setMonth(c.getMonth()+1,1),c.setHours(-24,0,0,0);for(var e,f=c.getDay(),g=(c.getDate()+(d+(6-f)))/7,h=[],i=0,j=0;g>i;i++){h[i]=[];for(var k=0;7>k;k++)if(0==i&&d>k)h[i].push("");else{if(e=new Date(b),e.setDate(e.getDate()+j),e>c)break;h[i].push(e),j++}}return{start:b,end:c,days:h,loops:g}},setDate:function(a){for(var b in a)if(this.date[b]&&this._isDate(a[b])){a[b].setHours(1,1,1,0),this.date[b].value=a[b],this.dateVal[b]=a[b];var d=$(this.dateDoms[b]);d.removeCls(this.buildSelectCls(b)),d.removeCls(this.buildSelectCls());var e=$(this.root.query('[data-date="'+c.Date.format(a[b],"Y-m-d")+'"]')[0]);e.hasClass("valid")&&(e.addClass(this.buildSelectCls(b)),e.addClass(this.buildSelectCls())),this.dateDoms[b]=e}},getDate:function(){return this.dateVal}});e.register({name:f,fn:k})}});